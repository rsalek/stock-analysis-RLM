{"cells":[{"cell_type":"code","source":["# @title üöÄ Phase 1: Stock Analysis Engine (Context Aware & Full Pipeline)\n","#\n","# DESCRIPTION:\n","# This script performs the raw analysis using the NEW Google GenAI SDK (v1.0+).\n","# 1. Reads prompts (1-13) and input files (PDFs, HTML, TXT) from Drive.\n","# 2. Uploads context to Gemini using the modern Client API.\n","# 3. Runs analysis steps in a specific LOGICAL ORDER.\n","# 4. **FIXED:** Force-feeds Ticker to prevent \"What company?\" loops.\n","# 5. **FIXED:** Upload method uses 'file' parameter to avoid keyword errors.\n","\n","import os\n","import re\n","import time\n","import shutil\n","import glob\n","import subprocess\n","import sys\n","from pathlib import Path\n","\n","# ==========================================\n","# üì¶ DEPENDENCIES\n","# ==========================================\n","def install_dependencies():\n","    \"\"\"Checks and installs the new Google GenAI SDK if missing.\"\"\"\n","    print(\"‚öôÔ∏è Installing new Google GenAI SDK...\")\n","    try:\n","        import google.genai\n","        print(\"   ‚úÖ google-genai is installed.\")\n","    except ImportError:\n","        subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", \"-U\", \"google-genai\"])\n","        print(\"   ‚úÖ google-genai installed successfully.\")\n","\n","install_dependencies()\n","\n","from google import genai\n","from google.genai import types\n","from google.colab import drive\n","\n","# ==========================================\n","# ‚öôÔ∏è CONFIGURATION\n","# ==========================================\n","\n","# 1. API SETUP\n","API_KEY = \"AIzaSyDwHjGqpWHQ7-cEpzHA1R8gg-UxOqUK8Ho \"\n","\n","# 2. GOOGLE DRIVE PATHS\n","BASE_DRIVE_PATH = \"/content/drive/My Drive/Stock_Analysis\"\n","PROMPTS_DIR = os.path.join(BASE_DRIVE_PATH, \"Prompts8\")\n","INPUT_DIR = os.path.join(BASE_DRIVE_PATH, \"Input\")\n","RESULTS_BASE_DIR = os.path.join(BASE_DRIVE_PATH, \"Results\")\n","\n","# 3. MODEL SELECTION\n","MODEL_NAME = \"gemini-3-pro-preview\"\n","\n","# 4. EXECUTION ORDER\n","EXECUTION_ORDER = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]\n","\n","# ==========================================\n","# üõ†Ô∏è HELPER FUNCTIONS\n","# ==========================================\n","\n","def setup_environment():\n","    \"\"\"Mounts Drive and initializes the GenAI client.\"\"\"\n","    print(\"üìÇ Mounting Google Drive...\")\n","    drive.mount('/content/drive')\n","    print(f\"üîë Configuring Gemini Client with model: {MODEL_NAME}...\")\n","    client = genai.Client(api_key=API_KEY)\n","\n","    if not os.path.exists(PROMPTS_DIR):\n","        raise FileNotFoundError(f\"‚ùå Prompts directory not found at: {PROMPTS_DIR}\")\n","    if not os.path.exists(INPUT_DIR):\n","        os.makedirs(INPUT_DIR)\n","\n","    return client\n","\n","def get_prompts_by_id(prompt_dir):\n","    \"\"\"Reads all prompts and returns a dictionary mapped by Step Number.\"\"\"\n","    prompts = {}\n","    print(f\"üìñ Reading prompts from {prompt_dir}...\")\n","    files = glob.glob(os.path.join(prompt_dir, \"*.txt\")) + glob.glob(os.path.join(prompt_dir, \"*.md\"))\n","\n","    for filepath in files:\n","        filename = os.path.basename(filepath)\n","        match = re.match(r\"(\\d+)\", filename)\n","        if match:\n","            step_num = int(match.group(1))\n","            with open(filepath, 'r', encoding='utf-8') as f:\n","                prompts[step_num] = f.read()\n","            print(f\"   Found Prompt {step_num}: {filename}\")\n","\n","    if not prompts:\n","        raise ValueError(\"‚ùå No numbered prompt files found!\")\n","    return prompts\n","\n","def upload_knowledge_base(client, input_dir):\n","    \"\"\"Uploads files using the NEW client.files.upload method.\"\"\"\n","    file_objects = []\n","    supported = ['.pdf', '.txt', '.md', '.csv', '.jpg', '.png', '.html', '.htm']\n","\n","    print(f\"üì§ Scanning Knowledge Base in {input_dir}...\")\n","    files_found = [f for f in os.listdir(input_dir) if os.path.splitext(f)[1].lower() in supported]\n","\n","    if not files_found:\n","        print(\"‚ö†Ô∏è No input files found. Using generic knowledge.\")\n","        return []\n","\n","    for filename in files_found:\n","        file_path = os.path.join(input_dir, filename)\n","        print(f\"   Uploading: {filename}...\")\n","        try:\n","            # FIX: Using 'file' kwarg (standard for v1.0) or positional if needed\n","            uploaded_file = client.files.upload(file=file_path)\n","\n","            # Wait for processing\n","            while uploaded_file.state.name == \"PROCESSING\":\n","                print(\"   ...processing...\", end='\\r')\n","                time.sleep(2)\n","                uploaded_file = client.files.get(name=uploaded_file.name)\n","\n","            if uploaded_file.state.name == \"FAILED\":\n","                print(f\"‚ùå Failed to process {filename}\")\n","                continue\n","\n","            file_objects.append(uploaded_file)\n","            print(f\"   ‚úÖ Ready: {filename}\")\n","\n","        except Exception as e:\n","            print(f\"   ‚ùå Error uploading {filename}: {e}\")\n","\n","    return file_objects\n","\n","def extract_phase(text):\n","    \"\"\"Parses Step 1 output to find the Business Phase (1-6).\"\"\"\n","    match = re.search(r\"Phase\\s?[:\\-]?\\s?(\\d)\", text, re.IGNORECASE)\n","    return match.group(1) if match else \"4\"\n","\n","def generate_with_retry(client, message_contents, max_retries=5):\n","    \"\"\"Generates content with exponential backoff.\"\"\"\n","    base_delay = 15\n","    for attempt in range(max_retries):\n","        try:\n","            response = client.models.generate_content(\n","                model=MODEL_NAME,\n","                contents=message_contents\n","            )\n","            return response\n","        except Exception as e:\n","            if \"429\" in str(e) or \"quota\" in str(e).lower() or \"503\" in str(e):\n","                wait_time = base_delay * (attempt + 1)\n","                print(f\"\\n   üõë API Busy/Limit. Waiting {wait_time}s... ({attempt+1}/{max_retries})\")\n","                time.sleep(wait_time)\n","            else:\n","                raise e\n","    raise Exception(\"‚ùå Max retries exceeded.\")\n","\n","def archive_inputs(input_dir, results_dir):\n","    \"\"\"Moves processed input files to the result folder.\"\"\"\n","    archive_path = os.path.join(results_dir, \"Source_Docs\")\n","    os.makedirs(archive_path, exist_ok=True)\n","    for f in os.listdir(input_dir):\n","        src, dst = os.path.join(input_dir, f), os.path.join(archive_path, f)\n","        if os.path.isfile(src): shutil.move(src, dst)\n","    print(\"‚úÖ Input folder cleared.\")\n","\n","# ==========================================\n","# üöÄ MAIN WORKFLOW\n","# ==========================================\n","\n","def run_analysis():\n","    client = setup_environment()\n","\n","    ticker = input(\"Enter Stock Ticker (e.g., TSLA): \").upper().strip()\n","    if not ticker: return\n","\n","    # --- USER CONTEXT COLLECTION ---\n","    print(\"\\n--- üíº Portfolio Context (Optional but Recommended) ---\")\n","    has_position = input(\"Do you currently own this stock? (y/n): \").lower().strip() == 'y'\n","\n","    shares = \"0\"\n","    avg_cost = \"0.00\"\n","    target_alloc = \"5\" # Default 5%\n","\n","    if has_position:\n","        shares = input(\"   Number of Shares: \").strip()\n","        avg_cost = input(\"   Average Cost ($): \").strip()\n","\n","    target_alloc_input = input(\"   Target Portfolio Allocation % (Default 5): \").strip()\n","    if target_alloc_input: target_alloc = target_alloc_input\n","\n","    # Construct the Context String\n","    user_context_str = f\"\"\"\n","    USER PORTFOLIO CONTEXT:\n","    - Current Shares: {shares}\n","    - Average Cost: ${avg_cost}\n","    - Target Allocation: {target_alloc}%\n","    - Current Status: {\"Holding\" if has_position else \"Watching\"}\n","    \"\"\"\n","\n","    stock_results_dir = os.path.join(RESULTS_BASE_DIR, ticker)\n","    os.makedirs(stock_results_dir, exist_ok=True)\n","    print(f\"üìÇ Results will be saved to: {stock_results_dir}\")\n","\n","    all_prompts = get_prompts_by_id(PROMPTS_DIR)\n","    kb_files = upload_knowledge_base(client, INPUT_DIR)\n","    detected_phase = \"Unknown\"\n","\n","    print(\"\\n‚ö° STARTING ANALYSIS CHAIN ‚ö°\")\n","\n","    for step_num in EXECUTION_ORDER:\n","        if step_num not in all_prompts:\n","            print(f\"‚ö†Ô∏è Warning: Step {step_num} prompt not found. Skipping.\")\n","            continue\n","\n","        print(f\"\\n--- Running Step {step_num} ---\")\n","        prompt_template = all_prompts[step_num]\n","\n","        message_contents = []\n","        if kb_files:\n","            message_contents.extend(kb_files)\n","\n","        # --- CRITICAL FIX: OVERRIDE INJECTION ---\n","        override_header = f\"\"\"\n","        SYSTEM OVERRIDE:\n","        The user has ALREADY provided the company.\n","        TARGET COMPANY: {ticker} ({ticker})\n","        TARGET PHASE: {detected_phase}\n","\n","        INSTRUCTIONS:\n","        1. Ignore any requests to \"ask the user\" for the company name.\n","        2. Proceed IMMEDIATELY with the analysis for {ticker}.\n","        3. Do NOT output \"What company would you like me to analyze?\".\n","        ------------------------------------------------------------\n","        \"\"\"\n","\n","        final_prompt = override_header + prompt_template.replace(\"{TICKER}\", ticker).replace(\"[Company Name]\", ticker)\n","\n","        # Inject Phase Logic\n","        if step_num == 5 or step_num == 7:\n","            print(f\"   ‚ÑπÔ∏è Injecting Phase {detected_phase} into instructions...\")\n","            final_prompt += f\"\\n\\nCRITICAL CONTEXT: Company is PHASE {detected_phase}. Use metrics for PHASE {detected_phase}.\"\n","\n","        # Inject User Context\n","        if step_num == 12 or step_num == 13:\n","            print(f\"   üíº Injecting Portfolio Context...\")\n","            final_prompt += f\"\\n\\n{user_context_str}\\n\\nINSTRUCTION: Use this specific portfolio data to tailor the Buy/Sell ladder and Behavioral Bias check.\"\n","\n","        message_contents.append(final_prompt)\n","\n","        try:\n","            response = generate_with_retry(client, message_contents)\n","            result_text = response.text\n","\n","            if step_num == 1:\n","                detected_phase = extract_phase(result_text)\n","                print(f\"   ‚úÖ Identified Business Phase: {detected_phase}\")\n","\n","            output_filename = f\"Step_{step_num}_Output.md\"\n","            with open(os.path.join(stock_results_dir, output_filename), \"w\", encoding=\"utf-8\") as f:\n","                f.write(result_text)\n","\n","            print(f\"   üíæ Saved {output_filename}\")\n","            print(\"   üí§ Cooling down (5s)...\")\n","            time.sleep(5)\n","\n","        except Exception as e:\n","            print(f\"   ‚ùå Failed at Step {step_num}: {e}\")\n","\n","    # 5. Final Cleanup\n","    if kb_files:\n","        archive_inputs(INPUT_DIR, stock_results_dir)\n","\n","    print(f\"\\nüéâ Analysis Complete for {ticker}!\")\n","    print(f\"üëâ Now run the 'Stock Report Generator' script to build the PDF.\")\n","\n","if __name__ == \"__main__\":\n","    run_analysis()"],"outputs":[{"output_type":"stream","name":"stdout","text":["‚öôÔ∏è Installing new Google GenAI SDK...\n","   ‚úÖ google-genai is installed.\n","üìÇ Mounting Google Drive...\n","Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount(\"/content/drive\", force_remount=True).\n","üîë Configuring Gemini Client with model: gemini-3-pro-preview...\n","Enter Stock Ticker (e.g., TSLA): GRAB\n","\n","--- üíº Portfolio Context (Optional but Recommended) ---\n","Do you currently own this stock? (y/n): y\n","   Number of Shares: 129\n","   Average Cost ($): 4.46\n","   Target Portfolio Allocation % (Default 5): 0.5\n","üìÇ Results will be saved to: /content/drive/My Drive/Stock_Analysis/Results/GRAB\n","üìñ Reading prompts from /content/drive/My Drive/Stock_Analysis/Prompts8...\n","   Found Prompt 1: 1-Business Phase Analysis.md\n","   Found Prompt 2: 2-Business Analysis.md\n","   Found Prompt 3: 3-Moat Analysis.md\n","   Found Prompt 4: 4-Long-Term Potential Growth Drivers Analysis.md\n","   Found Prompt 7: 7-Company Valuation Metrics Analysis Based on Business.md\n","   Found Prompt 8: 8-Price & sentiment Analysis.md\n","   Found Prompt 9: 9-Anitifragile various methods.md\n","   Found Prompt 10: 10-Reverse DCF.md\n","   Found Prompt 11: 11-Intrinsic Valuation.md\n","   Found Prompt 6: 6-Risk Analysis.md\n","   Found Prompt 5: 5-Business Phase Key Metrics.md\n","   Found Prompt 12: 12-Final Decision Buy Plan.md\n","   Found Prompt 13: 13-Behavioral Bias Checkv1.2.md\n","üì§ Scanning Knowledge Base in /content/drive/My Drive/Stock_Analysis/Input...\n","   Uploading: spglobal_virbiotechnology,inc._financialhighlights_15-01-2026_5e6a6199-061a-4462-8aab-c6b465c8cb30.pdf.pdf...\n","   ‚úÖ Ready: spglobal_virbiotechnology,inc._financialhighlights_15-01-2026_5e6a6199-061a-4462-8aab-c6b465c8cb30.pdf.pdf\n","   Uploading: spglobal_grabholdingslimited_financialhighlights_17-01-2026_4b0afdb0-4006-4ec2-8e94-b3cd4c54e4e4.pdf.pdf...\n","   ‚úÖ Ready: spglobal_grabholdingslimited_financialhighlights_17-01-2026_4b0afdb0-4006-4ec2-8e94-b3cd4c54e4e4.pdf.pdf\n","   Uploading: spglobal_grabholdingslimited_estimatehighlights_17-01-2026_85022166-7916-4e62-a53d-3461419b2418.pdf.pdf...\n","   ‚úÖ Ready: spglobal_grabholdingslimited_estimatehighlights_17-01-2026_85022166-7916-4e62-a53d-3461419b2418.pdf.pdf\n","   Uploading: spglobal_grabholdingslimited_multiples_17-01-2026_06e85270-8ac0-4711-95d0-e8e05bac0544.pdf.pdf...\n","   ‚úÖ Ready: spglobal_grabholdingslimited_multiples_17-01-2026_06e85270-8ac0-4711-95d0-e8e05bac0544.pdf.pdf\n","   Uploading: spglobal_grabholdingslimited_ownershipsummary_17-01-2026_d6687ee9-ed80-4c3d-b038-0606a0177525.pdf.pdf...\n","   ‚úÖ Ready: spglobal_grabholdingslimited_ownershipsummary_17-01-2026_d6687ee9-ed80-4c3d-b038-0606a0177525.pdf.pdf\n","   Uploading: spglobal_grabholdingslimited_transactionssummary_17-01-2026_b7389ada-3143-46b0-8ae2-fe9ca74c716e.pdf.pdf...\n","   ‚úÖ Ready: spglobal_grabholdingslimited_transactionssummary_17-01-2026_b7389ada-3143-46b0-8ae2-fe9ca74c716e.pdf.pdf\n","   Uploading: spglobal_grabholdingslimited_productsandservices_17-01-2026_1558cc1d-03fd-40c9-9177-04259b78ce45.pdf.pdf...\n","   ‚úÖ Ready: spglobal_grabholdingslimited_productsandservices_17-01-2026_1558cc1d-03fd-40c9-9177-04259b78ce45.pdf.pdf\n","   Uploading: spglobal_grabholdingslimited_competitors_17-01-2026_74e4c1b4-92e2-44d6-af67-d73e5bdfdfba.pdf.pdf...\n","   ‚úÖ Ready: spglobal_grabholdingslimited_competitors_17-01-2026_74e4c1b4-92e2-44d6-af67-d73e5bdfdfba.pdf.pdf\n","   Uploading: spglobal_grabholdingslimited_portfoliocompanies_17-01-2026_6c918898-511f-406b-9737-46d43966c240.pdf.pdf...\n","   ‚úÖ Ready: spglobal_grabholdingslimited_portfoliocompanies_17-01-2026_6c918898-511f-406b-9737-46d43966c240.pdf.pdf\n","   Uploading: spglobal_grabholdingslimited_keystats_17-01-2026_16085d9a-1f46-4b1a-898d-c7637829ddb0.pdf.pdf...\n","   ‚úÖ Ready: spglobal_grabholdingslimited_keystats_17-01-2026_16085d9a-1f46-4b1a-898d-c7637829ddb0.pdf.pdf\n","   Uploading: 251076393 (1).pdf...\n","   ‚úÖ Ready: 251076393 (1).pdf\n","   Uploading: 251076393.pdf...\n","   ‚úÖ Ready: 251076393.pdf\n","   Uploading: ft_data_extract.md...\n","   ‚úÖ Ready: ft_data_extract.md\n","   Uploading: grab_20241231_20f_core.md...\n","   ‚úÖ Ready: grab_20241231_20f_core.md\n","\n","‚ö° STARTING ANALYSIS CHAIN ‚ö°\n","\n","--- Running Step 1 ---\n","   ‚úÖ Identified Business Phase: 2\n","   üíæ Saved Step_1_Output.md\n","   üí§ Cooling down (5s)...\n","\n","--- Running Step 2 ---\n","   üíæ Saved Step_2_Output.md\n","   üí§ Cooling down (5s)...\n","\n","--- Running Step 3 ---\n","   üíæ Saved Step_3_Output.md\n","   üí§ Cooling down (5s)...\n","\n","--- Running Step 4 ---\n","   üíæ Saved Step_4_Output.md\n","   üí§ Cooling down (5s)...\n","\n","--- Running Step 5 ---\n","   ‚ÑπÔ∏è Injecting Phase 2 into instructions...\n","   üíæ Saved Step_5_Output.md\n","   üí§ Cooling down (5s)...\n","\n","--- Running Step 6 ---\n","   üíæ Saved Step_6_Output.md\n","   üí§ Cooling down (5s)...\n","\n","--- Running Step 7 ---\n","   ‚ÑπÔ∏è Injecting Phase 2 into instructions...\n","   üíæ Saved Step_7_Output.md\n","   üí§ Cooling down (5s)...\n","\n","--- Running Step 8 ---\n","   üíæ Saved Step_8_Output.md\n","   üí§ Cooling down (5s)...\n","\n","--- Running Step 9 ---\n","   üíæ Saved Step_9_Output.md\n","   üí§ Cooling down (5s)...\n","\n","--- Running Step 10 ---\n","   üíæ Saved Step_10_Output.md\n","   üí§ Cooling down (5s)...\n","\n","--- Running Step 11 ---\n","   üíæ Saved Step_11_Output.md\n","   üí§ Cooling down (5s)...\n","\n","--- Running Step 12 ---\n","   üíº Injecting Portfolio Context...\n","   üíæ Saved Step_12_Output.md\n","   üí§ Cooling down (5s)...\n","\n","--- Running Step 13 ---\n","   üíº Injecting Portfolio Context...\n","   üíæ Saved Step_13_Output.md\n","   üí§ Cooling down (5s)...\n","‚úÖ Input folder cleared.\n","\n","üéâ Analysis Complete for GRAB!\n","üëâ Now run the 'Stock Report Generator' script to build the PDF.\n"]}],"execution_count":2,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"Z9lMv8CXosKK","outputId":"7b7b3377-91ae-49a1-c3d5-8a1e1d1c8308","cellView":"form","collapsed":true,"executionInfo":{"status":"ok","timestamp":1768674860890,"user_tz":0,"elapsed":778731,"user":{"displayName":"R Salek","userId":"10385472356397534115"}}}},{"cell_type":"code","source":["# @title üöÄ Phase 2: Stock Report Generator (Resilient Edition)\n","#\n","# DESCRIPTION:\n","# This script runs AFTER the Phase 1 analysis is complete.\n","# 1. Scans your Drive for the markdown files generated by the analysis script.\n","# 2. Uses Gemini (NEW SDK) to read them all and write a high-level \"Executive Summary\".\n","# 3. Compiles the Summary + All Steps into a Report.\n","#\n","# RESILIENCE UPDATE:\n","# - If PDF generation libraries (xhtml2pdf) fail to install, this script\n","#   automatically falls back to generating a High-Quality HTML Report.\n","# - This guarantees you get a readable, colorful report no matter what.\n","\n","import os\n","import sys\n","import glob\n","import time\n","import re\n","import datetime\n","import subprocess\n","from google.colab import drive\n","\n","# ==========================================\n","# üì¶ DEPENDENCY SETUP (Fail-Safe)\n","# ==========================================\n","\n","def install_dependencies():\n","    \"\"\"Attempts to install PDF libraries. Returns True if successful.\"\"\"\n","    print(\"‚öôÔ∏è Checking dependencies...\")\n","    try:\n","        import xhtml2pdf\n","        return True\n","    except ImportError:\n","        print(\"   ‚ö†Ô∏è Libraries missing. Attempting installation...\")\n","        try:\n","            # We try a cleaner install without forcing specific versions first\n","            subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", \"markdown\", \"xhtml2pdf\", \"google-genai\"])\n","            return True\n","        except subprocess.CalledProcessError:\n","            print(\"   ‚ùå PDF Library installation failed. Switching to HTML-Only mode.\")\n","            return False\n","\n","# Attempt installation\n","PDF_MODE = install_dependencies()\n","\n","# Import what we can\n","import markdown\n","try:\n","    from xhtml2pdf import pisa\n","except ImportError:\n","    PDF_MODE = False # Fallback if import fails even after install\n","\n","from google import genai\n","\n","# ==========================================\n","# ‚öôÔ∏è CONFIGURATION\n","# ==========================================\n","\n","API_KEY = \"AIzaSyDwHjGqpWHQ7-cEpzHA1R8gg-UxOqUK8Ho \"\n","RESULTS_BASE_DIR = \"/content/drive/My Drive/Stock_Analysis/Results\"\n","MODEL_NAME = \"gemini-3-flash-preview\"\n","\n","# ==========================================\n","# üõ†Ô∏è HELPER FUNCTIONS\n","# ==========================================\n","\n","def setup_environment():\n","    print(\"üìÇ Mounting Google Drive...\")\n","    drive.mount('/content/drive')\n","    print(f\"üîë Configuring Gemini Client ({MODEL_NAME})...\")\n","    client = genai.Client(api_key=API_KEY)\n","    return client\n","\n","def apply_styling(text):\n","    \"\"\"Applies HTML color tags to the text.\"\"\"\n","    # üé® Color Codes\n","    C_GREEN = \"#27ae60\"\n","    C_RED = \"#c0392b\"\n","    C_ORANGE = \"#e67e22\"\n","    C_GREY = \"#7f8c8d\"\n","\n","    tag_map = {\n","        # POSITIVE\n","        r\"\\[(GREEN|STRONG|POSITIVE|BULLISH|WIDE|WIDENING|ACCUMULATION|ACCUMULATING|UP|LOW|UNDERVALUED|BUY|ADD|ANTIFRAGILE|ROBUST|INTACT|IMPROVING|GOOD|EXCELLENT|EUPHORIC)\\]\":\n","            f\"<b style='color:{C_GREEN};'>[\\\\1]</b>\",\n","        # NEGATIVE\n","        r\"\\[(RED|WEAK|NEGATIVE|BEARISH|NARROW|NARROWING|NONE|DISTRIBUTION|DISTRIBUTING|DOWN|HIGH|CRITICAL|OVERVALUED|SELL|TRIM|FRAGILE|BROKEN|DETERIORATING|BAD|POOR|FEARFUL|THE UGLY)\\]\":\n","            f\"<b style='color:{C_RED};'>[\\\\1]</b>\",\n","        # NEUTRAL\n","        r\"\\[(YELLOW|MODERATE|NEUTRAL|STABLE|MIXED|FLAT|HOLD|FAIRLY VALUED|MED|MEDIUM|NORMAL|UNDER REVIEW|WATCH|ALERT)\\]\":\n","            f\"<b style='color:{C_ORANGE};'>[\\\\1]</b>\",\n","        # N/A\n","        r\"\\[(N/A|NA)\\]\":\n","            f\"<span style='color:{C_GREY};'>[\\\\1]</span>\",\n","    }\n","\n","    for pattern, replacement in tag_map.items():\n","        text = re.sub(pattern, replacement, text, flags=re.IGNORECASE)\n","    return text\n","\n","def load_analysis_files(ticker):\n","    stock_dir = os.path.join(RESULTS_BASE_DIR, ticker)\n","    if not os.path.exists(stock_dir):\n","        print(f\"‚ùå Error: Folder not found for {ticker}\")\n","        return None\n","\n","    results = {}\n","    print(f\"üìñ Reading analysis files for {ticker}...\")\n","\n","    found_any = False\n","    for i in range(1, 16):\n","        filename = f\"Step_{i}_Output.md\"\n","        path = os.path.join(stock_dir, filename)\n","        if os.path.exists(path):\n","            with open(path, \"r\", encoding=\"utf-8\") as f:\n","                results[i] = f.read()\n","            found_any = True\n","\n","    if not found_any:\n","        print(\"‚ùå No files found!\")\n","        return None\n","    return results\n","\n","def generate_executive_summary(client, ticker, report_results):\n","    print(\"üß† Synthesizing Executive Summary...\")\n","    combined_insights = \"\\n\".join([f\"--- STEP {k} OUTPUT ---\\n{v[:4000]}\" for k, v in report_results.items()])\n","\n","    prompt = f\"\"\"\n","    ROLE: Chief Investment Officer. TASK: 1-page Summary for {ticker}.\n","    REQUIREMENTS: Investment Thesis, Valuation, Risks, Verdict.\n","    FORMAT: Markdown.\n","    DATA: {combined_insights}\n","    \"\"\"\n","    try:\n","        response = client.models.generate_content(model=MODEL_NAME, contents=prompt)\n","        return response.text\n","    except Exception as e:\n","        return f\"Error generating summary: {e}\"\n","\n","def generate_report_file(ticker, results_dir, summary_text, report_results):\n","    \"\"\"\n","    Generates either a PDF (if libs exist) or a beautiful HTML file (fallback).\n","    \"\"\"\n","\n","    # --- CSS STYLING (Works for both PDF and HTML) ---\n","    css_style = \"\"\"\n","    <style>\n","        body { font-family: Helvetica, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; line-height: 1.6; color: #333; background: #fdfdfd; }\n","        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-top: 40px; }\n","        h2 { color: #2980b9; background: #eaf2f8; padding: 10px; border-left: 5px solid #2980b9; margin-top: 30px; }\n","        h3 { color: #7f8c8d; text-transform: uppercase; margin-top: 20px; }\n","        .summary-box { border: 2px solid #27ae60; background-color: #f0fcf4; padding: 20px; border-radius: 8px; margin-bottom: 40px; }\n","        table { width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #ddd; }\n","        th { background: #34495e; color: white; padding: 10px; text-align: left; }\n","        td { border: 1px solid #eee; padding: 8px; vertical-align: top; }\n","        tr:nth-child(even) { background: #f9f9f9; }\n","        code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; font-family: monospace; color: #c0392b; }\n","        .footer { text-align: center; font-size: 0.8em; color: #999; margin-top: 50px; border-top: 1px solid #eee; padding-top: 20px; }\n","    </style>\n","    \"\"\"\n","\n","    # --- HTML ASSEMBLY ---\n","    html_content = f\"<html><head>{css_style}</head><body>\"\n","\n","    # Title\n","    html_content += f\"\"\"\n","    <div style=\"text-align: center; margin-bottom: 50px;\">\n","        <h1 style=\"border:none; font-size: 3em; margin-bottom: 0;\">STOCK ANALYSIS REPORT</h1>\n","        <h2 style=\"border:none; background:none; font-size: 2.5em; color: #3498db; margin-top: 0;\">{ticker}</h2>\n","        <p>Generated by AI Analyst Engine | {time.strftime(\"%Y-%m-%d\")}</p>\n","    </div>\n","    \"\"\"\n","\n","    # Summary\n","    html_content += f\"<h1>EXECUTIVE SUMMARY</h1><div class='summary-box'>{markdown.markdown(apply_styling(summary_text))}</div>\"\n","\n","    # Modules\n","    for step in sorted(report_results.keys()):\n","        raw = report_results[step]\n","        styled = apply_styling(raw)\n","        html_body = markdown.markdown(styled, extensions=['tables'])\n","        html_content += f\"<h1>MODULE {step} ANALYSIS</h1>{html_body}<hr>\"\n","\n","    html_content += \"<div class='footer'>End of Report</div></body></html>\"\n","\n","    # --- OUTPUT GENERATION ---\n","\n","    if PDF_MODE:\n","        print(\"\\nüìë PDF Mode Active. Generating PDF...\")\n","        pdf_path = os.path.join(results_dir, f\"{ticker}_Full_Report.pdf\")\n","        try:\n","            with open(pdf_path, \"w+b\") as f:\n","                pisa_status = pisa.CreatePDF(html_content, dest=f)\n","            if not pisa_status.err:\n","                print(f\"‚úÖ PDF Saved: {pdf_path}\")\n","                return\n","        except Exception as e:\n","            print(f\"‚ùå PDF Failed ({e}). Falling back to HTML...\")\n","\n","    # Fallback to HTML\n","    html_path = os.path.join(results_dir, f\"{ticker}_Full_Report.html\")\n","    with open(html_path, \"w\", encoding=\"utf-8\") as f:\n","        f.write(html_content)\n","\n","    print(f\"\\n‚úÖ HTML Report Saved: {html_path}\")\n","    print(\"üëâ Open this file in your browser to view the report (You can Print->Save as PDF from Chrome).\")\n","\n","# ==========================================\n","# üöÄ MAIN\n","# ==========================================\n","\n","def run_reporting():\n","    client = setup_environment()\n","    ticker = input(\"Enter Ticker to Report On (e.g., TSLA): \").upper().strip()\n","    if not ticker: return\n","\n","    data = load_analysis_files(ticker)\n","    if not data: return\n","\n","    summary = generate_executive_summary(client, ticker, data)\n","\n","    stock_dir = os.path.join(RESULTS_BASE_DIR, ticker)\n","    generate_report_file(ticker, stock_dir, summary, data)\n","\n","    print(f\"\\nüéâ Process Complete! Check folder: {stock_dir}\")\n","\n","if __name__ == \"__main__\":\n","    run_reporting()"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"collapsed":true,"id":"_8XKSYkGY0LS","executionInfo":{"status":"ok","timestamp":1768681260624,"user_tz":0,"elapsed":28781,"user":{"displayName":"R Salek","userId":"10385472356397534115"}},"outputId":"13199b90-5e5e-4545-bd9b-1235776976e8"},"execution_count":6,"outputs":[{"output_type":"stream","name":"stdout","text":["‚öôÔ∏è Checking dependencies...\n","   ‚ö†Ô∏è Libraries missing. Attempting installation...\n","üìÇ Mounting Google Drive...\n","Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount(\"/content/drive\", force_remount=True).\n","üîë Configuring Gemini Client (gemini-3-flash-preview)...\n","Enter Ticker to Report On (e.g., TSLA): GRAB\n","üìñ Reading analysis files for GRAB...\n","üß† Synthesizing Executive Summary...\n","\n","üìë PDF Mode Active. Generating PDF...\n","‚ùå PDF Failed ('>' not supported between instances of 'NoneType' and 'NoneType'). Falling back to HTML...\n","\n","‚úÖ HTML Report Saved: /content/drive/My Drive/Stock_Analysis/Results/GRAB/GRAB_Full_Report.html\n","üëâ Open this file in your browser to view the report (You can Print->Save as PDF from Chrome).\n","\n","üéâ Process Complete! Check folder: /content/drive/My Drive/Stock_Analysis/Results/GRAB\n"]}]},{"cell_type":"code","source":["# @title üöÄ Phase 3: Stock Audio Podcast Generator (Enhanced Config)\n","#\n","# DESCRIPTION:\n","# This script mimics the \"Audio Overview\" feature of NotebookLM.\n","# 1. Reads the analysis (Markdown files) generated in Phase 1.\n","# 2. Uses Gemini to write a natural, 2-person podcast script based on your settings.\n","# 3. Uses the Gemini TTS API to generate a high-quality audio file (.wav).\n","#\n","# UPDATES (v2.1):\n","# - VOICE UPDATE: Changed default narrator to 'Charon' (Male).\n","# - DOCS: Added list of available voices (Male/Female).\n","# - CONFIGURATION: Added controls for Duration (Short/Med/Long) and Style (Casual/Pro/Debate).\n","# - PERSONALITY: Custom host names and dynamic prompting logic.\n","# - OUTPUT: Saves a file named \"{TICKER}_Deep_Dive_Podcast.wav\".\n","\n","import os\n","import glob\n","import time\n","import json\n","import wave\n","import base64\n","import requests\n","import google.generativeai as genai\n","from google.colab import drive\n","\n","# ==========================================\n","# ‚öôÔ∏è CONFIGURATION (TWEAK THESE!)\n","# ==========================================\n","\n","API_KEY = \"AIzaSyDwHjGqpWHQ7-cEpzHA1R8gg-UxOqUK8Ho \"\n","RESULTS_BASE_DIR = \"/content/drive/My Drive/Stock_Analysis/Results\"\n","\n","# --- PODCAST SETTINGS ---\n","# Duration: \"Short\" (2 min), \"Medium\" (5 min), \"Long\" (8-10 min)\n","PODCAST_DURATION = \"Medium\"\n","\n","# Style:\n","# \"Casual\" (Friendly banter, interruptions)\n","# \"Professional\" (Serious news style, structured)\n","# \"Debate\" (Host A is Bull, Host B is Bear, they argue)\n","PODCAST_STYLE = \"Casual\"\n","\n","# Host Names:\n","HOST_1_NAME = \"Reza\"  # The Optimist\n","HOST_2_NAME = \"Tracy\" # The Skeptic\n","\n","# --- VOICE SELECTION ---\n","# \"Aoede\"  -> Female, Energetic, Bright (Good for Casual)\n","# \"Puck\"   -> Female, Soft, Clear (Good for Professional)\n","# \"Charon\" -> Male, Deep, Authoritative (Good for Serious/Bearish)\n","# \"Fenrir\" -> Male, Fast, Intense (Good for Debate)\n","NARRATOR_VOICE = \"Charon\"\n","\n","# AI Models\n","TEXT_MODEL_NAME = \"gemini-3-flash-preview\"\n","AUDIO_MODEL_NAME = \"gemini-2.5-flash-preview-tts\"\n","\n","# ==========================================\n","# üõ†Ô∏è HELPER FUNCTIONS\n","# ==========================================\n","\n","def setup_environment():\n","    \"\"\"Mounts Drive and configures Gemini.\"\"\"\n","    print(\"üìÇ Mounting Google Drive...\")\n","    drive.mount('/content/drive')\n","    genai.configure(api_key=API_KEY)\n","\n","def load_analysis_text(ticker):\n","    \"\"\"Loads all Markdown analysis files for the ticker.\"\"\"\n","    stock_dir = os.path.join(RESULTS_BASE_DIR, ticker)\n","    if not os.path.exists(stock_dir):\n","        print(f\"‚ùå Results not found for {ticker}\")\n","        return None\n","\n","    print(f\"üìñ Reading analysis files for {ticker}...\")\n","    combined_text = \"\"\n","    # Load all steps\n","    files = sorted(glob.glob(os.path.join(stock_dir, \"Step_*_Output.md\")))\n","    if not files:\n","        print(\"‚ùå No analysis files found.\")\n","        return None\n","\n","    for f in files:\n","        with open(f, \"r\", encoding=\"utf-8\") as file:\n","            # We take the first 3000 chars of each step to fit context\n","            combined_text += f\"\\n--- {os.path.basename(f)} ---\\n\" + file.read()[:3000]\n","\n","    return combined_text\n","\n","def get_style_instructions(duration, style):\n","    \"\"\"Returns dynamic system instructions based on user config.\"\"\"\n","\n","    # Duration Logic\n","    if duration == \"Short\":\n","        len_instruct = \"LENGTH: Approx 300-400 words (2 minutes). Focus ONLY on the Executive Summary verdict and the single biggest Risk. Skip the deep metric analysis.\"\n","    elif duration == \"Medium\":\n","        len_instruct = \"LENGTH: Approx 800-1000 words (5 minutes). Cover the Thesis, Valuation, Moat, and Risks. A balanced overview.\"\n","    else: # Long\n","        len_instruct = \"LENGTH: Approx 1500 words (8-10 minutes). DEEP DIVE. You must quote specific numbers (Revenue, Margins, P/E) from the text. Discuss the 'Moat' detailed mechanics. Debate the valuation models.\"\n","\n","    # Style Logic\n","    if style == \"Casual\":\n","        style_instruct = \"TONE: Friendly, energetic, lots of idiomatic expressions ('Wow', 'Hold on', 'No way'). It should sound like two smart friends talking at a bar. Use interruptions/overlaps markers like [interrupts].\"\n","    elif style == \"Professional\":\n","        style_instruct = \"TONE: Serious, CNBC-style analysis. Professional terminology. Structured flow. No slang. Clear, crisp articulation of facts.\"\n","    else: # Debate\n","        style_instruct = f\"TONE: High Conflict. {HOST_1_NAME} is a permanent BULL who loves the stock. {HOST_2_NAME} is a permanent BEAR who hates it. They should argue (respectfully) about the numbers.\"\n","\n","    return len_instruct, style_instruct\n","\n","def generate_podcast_script(ticker, analysis_text):\n","    \"\"\"Generates a conversational script between two hosts.\"\"\"\n","    print(f\"‚úçÔ∏è  Writing Podcast Script ({PODCAST_DURATION} / {PODCAST_STYLE})...\")\n","\n","    len_instruct, style_instruct = get_style_instructions(PODCAST_DURATION, PODCAST_STYLE)\n","\n","    model = genai.GenerativeModel(TEXT_MODEL_NAME)\n","\n","    prompt = f\"\"\"\n","    ROLE: You are the producer of a top-tier financial podcast called \"Market Deep Dive\".\n","\n","    HOSTS:\n","    - **{HOST_1_NAME}**: Optimist, focuses on growth/vision.\n","    - **{HOST_2_NAME}**: Skeptic, focuses on risks/numbers.\n","\n","    TOPIC: Deep dive analysis of {ticker}.\n","\n","    CONFIG:\n","    1. {len_instruct}\n","    2. {style_instruct}\n","\n","    INSTRUCTIONS:\n","    1. Base the conversation STRICTLY on the provided analysis text.\n","    2. Format the output as a script: \"{HOST_1_NAME}: [Text]\"\n","    3. Do NOT include scene directions like *laughs* or [music fades] as the TTS engine cannot render them. Keep it to spoken text only.\n","    4. Start with a hook about the stock to grab attention.\n","\n","    INPUT DATA:\n","    {analysis_text}\n","    \"\"\"\n","\n","    # Retry logic for robust generation\n","    try:\n","        response = model.generate_content(prompt)\n","        return response.text\n","    except Exception as e:\n","        print(f\"‚ùå Script Generation Error: {e}\")\n","        return None\n","\n","def synthesize_audio(script_text, output_path):\n","    \"\"\"Uses the Gemini REST API to generate audio.\"\"\"\n","    print(\"üéôÔ∏è  Synthesizing Audio (This may take 30-60 seconds)...\")\n","\n","    url = f\"https://generativelanguage.googleapis.com/v1beta/models/{AUDIO_MODEL_NAME}:generateContent?key={API_KEY}\"\n","\n","    # Single-voice narration reading the script\n","    # Note: 'multiSpeakerVoiceConfig' is currently unstable on this endpoint.\n","    # We use a single high-quality voice to read the dialogue.\n","    payload = {\n","        \"contents\": [{\n","            \"parts\": [{\"text\": script_text}]\n","        }],\n","        \"generationConfig\": {\n","            \"responseModalities\": [\"AUDIO\"],\n","            \"speechConfig\": {\n","                \"voiceConfig\": {\n","                    \"prebuiltVoiceConfig\": {\n","                        \"voiceName\": NARRATOR_VOICE\n","                    }\n","                }\n","            }\n","        }\n","    }\n","\n","    try:\n","        response = requests.post(url, headers={\"Content-Type\": \"application/json\"}, data=json.dumps(payload))\n","\n","        if response.status_code != 200:\n","            print(f\"‚ùå API Error: {response.text}\")\n","            return\n","\n","        response_json = response.json()\n","\n","        if \"candidates\" not in response_json or not response_json[\"candidates\"]:\n","            print(f\"‚ùå Error: No audio candidates returned.\")\n","            return\n","\n","        audio_content = response_json[\"candidates\"][0][\"content\"][\"parts\"][0][\"inlineData\"][\"data\"]\n","        pcm_data = base64.b64decode(audio_content)\n","\n","        # WAV Config (24kHz standard for Gemini)\n","        sample_rate = 24000\n","\n","        with wave.open(output_path, \"wb\") as wav_file:\n","            wav_file.setnchannels(1) # Mono\n","            wav_file.setsampwidth(2) # 16 bit\n","            wav_file.setframerate(sample_rate)\n","            wav_file.writeframes(pcm_data)\n","\n","        print(f\"‚úÖ Audio saved to: {output_path}\")\n","\n","    except Exception as e:\n","        print(f\"‚ùå Error saving audio: {e}\")\n","\n","# ==========================================\n","# üöÄ MAIN\n","# ==========================================\n","\n","def run_podcast_generator():\n","    setup_environment()\n","\n","    ticker = input(\"Enter Ticker for Podcast (e.g., TSLA): \").upper().strip()\n","    if not ticker: return\n","\n","    # 1. Load Text\n","    text_data = load_analysis_text(ticker)\n","    if not text_data: return\n","\n","    # 2. Generate Script\n","    script = generate_podcast_script(ticker, text_data)\n","    if not script: return\n","\n","    print(\"\\n--- Generated Script Preview ---\")\n","    print(script[:500] + \"...\\n\")\n","\n","    # 3. Generate Audio\n","    stock_dir = os.path.join(RESULTS_BASE_DIR, ticker)\n","\n","    # Filename includes settings for clarity\n","    filename = f\"{ticker}_Podcast_{PODCAST_DURATION}_{PODCAST_STYLE}.wav\"\n","    output_file = os.path.join(stock_dir, filename)\n","\n","    synthesize_audio(script, output_file)\n","\n","    print(f\"\\nüéß Podcast Ready! You can play it from: {output_file}\")\n","\n","if __name__ == \"__main__\":\n","    run_podcast_generator()"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":258},"id":"DpPNOKUznpg1","executionInfo":{"status":"ok","timestamp":1768093012592,"user_tz":0,"elapsed":203235,"user":{"displayName":"R Salek","userId":"10385472356397534115"}},"outputId":"44318707-ffe5-40f6-b869-9d9c5f189b4c"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["üìÇ Mounting Google Drive...\n","Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount(\"/content/drive\", force_remount=True).\n","Enter Ticker for Podcast (e.g., TSLA): FLGT\n","üìñ Reading analysis files for FLGT...\n","‚úçÔ∏è  Writing Podcast Script (Long / Professional)...\n","\n","--- Generated Script Preview ---\n","Reza: Welcome back to Market Deep Dive. Today, we are dissecting one of the most polarizing setups on the NASDAQ right now. It is a company that, at first glance, looks like a mathematical error. I am talking about Fulgent Genetics, ticker FLGT. Imagine a company with a market capitalization of approximately 847 million dollars that holds 819 million dollars in net cash and marketable securities. The market is effectively valuing a business generating over 280 million dollars in annual revenue a...\n","\n","üéôÔ∏è  Synthesizing Audio (This may take 30-60 seconds)...\n","‚úÖ Audio saved to: /content/drive/My Drive/Stock_Analysis/Results/FLGT/FLGT_Podcast_Long_Professional.wav\n","\n","üéß Podcast Ready! You can play it from: /content/drive/My Drive/Stock_Analysis/Results/FLGT/FLGT_Podcast_Long_Professional.wav\n"]}]},{"cell_type":"code","source":["# @title üöÄ Phase 4: Quarterly Delta Comparator (Thesis Tracker)\n","#\n","# DESCRIPTION:\n","# This script compares two sets of analysis results (e.g., Q4 2025 vs Q1 2026).\n","# It identifies \"Thesis Drift,\" metric acceleration/deceleration, and new risks.\n","#\n","# USAGE:\n","# 1. Ensure you have two folders: e.g., \"Results/TSLA_Q4_2025\" and \"Results/TSLA_Q1_2026\".\n","# 2. Run this script and paste the paths when prompted.\n","# 3. It generates a \"Comparison_Delta_Report.pdf\".\n","\n","import os\n","import glob\n","import time\n","import subprocess\n","import google.generativeai as genai\n","from google.colab import drive\n","\n","# ==========================================\n","# üì¶ DEPENDENCIES & SETUP\n","# ==========================================\n","\n","def install_dependencies():\n","    \"\"\"Ensures PDF libraries are installed.\"\"\"\n","    try:\n","        import markdown\n","        from xhtml2pdf import pisa\n","    except ImportError:\n","        print(\"‚öôÔ∏è Installing PDF libraries...\")\n","        subprocess.check_call([\n","            sys.executable, \"-m\", \"pip\", \"install\",\n","            \"markdown==3.5.1\", \"xhtml2pdf==0.2.13\", \"reportlab==3.6.13\"\n","        ])\n","        print(\"‚úÖ Dependencies installed.\")\n","\n","install_dependencies()\n","import markdown\n","from xhtml2pdf import pisa\n","\n","# ==========================================\n","# ‚öôÔ∏è CONFIGURATION\n","# ==========================================\n","\n","API_KEY = \"AIzaSyDwHjGqpWHQ7-cEpzHA1R8gg-UxOqUK8Ho \"\n","MODEL_NAME = \"gemini-3-flash-preview\"\n","\n","# Steps to Compare (Focusing on the most critical strategic shifts)\n","CRITICAL_STEPS = {\n","    1: \"Business Phase (Did the maturity change?)\",\n","    3: \"Moat Analysis (Is the advantage widening or narrowing?)\",\n","    4: \"Growth Drivers (Are they accelerating or stalling?)\",\n","    6: \"Risk Analysis (Did new threats emerge?)\",\n","    7: \"Valuation (Is it getting cheaper or more expensive?)\",\n","    8: \"Sentiment (Did the narrative flip?)\"\n","}\n","\n","# ==========================================\n","# üõ†Ô∏è COMPARATOR LOGIC\n","# ==========================================\n","\n","def setup_environment():\n","    print(\"üìÇ Mounting Google Drive...\")\n","    drive.mount('/content/drive')\n","    genai.configure(api_key=API_KEY)\n","\n","def get_file_content(folder, step_num):\n","    \"\"\"Retrieves content of a specific step from a specific folder.\"\"\"\n","    filename = f\"Step_{step_num}_Output.md\"\n","    path = os.path.join(folder, filename)\n","    if os.path.exists(path):\n","        with open(path, \"r\", encoding=\"utf-8\") as f:\n","            return f.read()\n","    return None\n","\n","def compare_step(model, step_num, step_name, old_text, new_text):\n","    \"\"\"Uses Gemini to compare old vs new text for a specific module.\"\"\"\n","    print(f\"   ‚öñÔ∏è Comparing Step {step_num}: {step_name}...\")\n","\n","    prompt = f\"\"\"\n","    ROLE: Senior Portfolio Manager tracking a position over time.\n","    TASK: Compare the \"Previous Analysis\" (Old) vs \"Current Analysis\" (New) for {step_name}.\n","\n","    GOAL: Identify **Thesis Drift** and **Material Changes**. Ignore minor noise.\n","\n","    INPUT DATA:\n","    --- OLD ANALYSIS ({step_name}) ---\n","    {old_text[:5000]}\n","\n","    --- NEW ANALYSIS ({step_name}) ---\n","    {new_text[:5000]}\n","\n","    OUTPUT FORMAT (Markdown):\n","    ### {step_name} Comparison\n","    * **Status:** [IMPROVING] / [STABLE] / [DETERIORATING]\n","    * **Key Change:** [1 sentence summary of the biggest shift]\n","    * **Details:**\n","        * [Point 1: e.g., \"Margins compressed by 200bps compared to last quarter\"]\n","        * [Point 2: e.g., \"New risk factor identified: Regulatory probe\"]\n","    \"\"\"\n","\n","    try:\n","        response = model.generate_content(prompt)\n","        return response.text\n","    except Exception as e:\n","        return f\"Error comparing Step {step_num}: {e}\"\n","\n","def generate_delta_summary(model, comparison_results, ticker):\n","    \"\"\"Synthesizes the overall verdict of the comparison.\"\"\"\n","    print(\"üß† Synthesizing Delta Verdict...\")\n","\n","    combined_diffs = \"\\n\\n\".join(comparison_results.values())\n","\n","    prompt = f\"\"\"\n","    ROLE: Chief Investment Officer.\n","    TASK: Write a \"Quarterly Update Note\" for {ticker} based on the changes identified below.\n","\n","    INPUT (Changes observed):\n","    {combined_diffs}\n","\n","    OUTPUT FORMAT (Markdown):\n","    # Quarterly Delta Update: {ticker}\n","\n","    ## üö® Executive Verdict\n","    * **Thesis Status:** [INTACT] / [BROKEN] / [UNDER REVIEW]\n","    * **Action:** [BUY MORE] / [HOLD] / [SELL]\n","\n","    ## üìâ The Good, The Bad, & The Ugly\n","    * **The Good:** [Top improvement]\n","    * **The Bad:** [Top deterioration]\n","    * **The Ugly:** [Any major new risk?]\n","\n","    ## üìù Summary of Changes\n","    [2-3 paragraphs summarizing the evolution of the company since the last report.]\n","    \"\"\"\n","\n","    try:\n","        response = model.generate_content(prompt)\n","        return response.text\n","    except Exception as e:\n","        return \"Error generating summary.\"\n","\n","# ==========================================\n","# üìÑ PDF GENERATION (Reusing Fixed Logic)\n","# ==========================================\n","\n","def apply_pdf_styling(text):\n","    # Same coloring logic as your Report Generator\n","    COLOR_GREEN = \"#27ae60\"\n","    COLOR_RED = \"#c0392b\"\n","    COLOR_ORANGE = \"#f39c12\"\n","\n","    text = re.sub(r\"\\[(IMPROVING|INTACT|BUY MORE|STABLE)\\]\", f\"<b style='color:{COLOR_GREEN};'>[\\\\1]</b>\", text, flags=re.IGNORECASE)\n","    text = re.sub(r\"\\[(DETERIORATING|BROKEN|SELL|THE UGLY)\\]\", f\"<b style='color:{COLOR_RED};'>[\\\\1]</b>\", text, flags=re.IGNORECASE)\n","    text = re.sub(r\"\\[(UNDER REVIEW|HOLD)\\]\", f\"<b style='color:{COLOR_ORANGE};'>[\\\\1]</b>\", text, flags=re.IGNORECASE)\n","\n","    return text\n","\n","def create_pdf_report(output_path, summary, details_dict):\n","    print(\"\\nüìë Assembling Delta PDF...\")\n","\n","    css = \"\"\"\n","    <style>\n","        @page { size: A4; margin: 1.5cm; }\n","        body { font-family: Helvetica, sans-serif; font-size: 10pt; color: #333; }\n","        h1 { color: #2c3e50; font-size: 20pt; border-bottom: 2px solid #3498db; margin-top: 20px; }\n","        h3 { color: #2980b9; background: #eaf2f8; padding: 5px; margin-top: 15px; }\n","        p { text-align: justify; line-height: 1.4; }\n","        .page-break { page-break-before: always; }\n","    </style>\n","    \"\"\"\n","\n","    html = f\"<html><head>{css}</head><body>\"\n","\n","    # Summary Section\n","    html += markdown.markdown(apply_pdf_styling(summary))\n","    html += \"<div class='page-break'></div>\"\n","\n","    # Details Section\n","    html += \"<h1>DETAILED MODULE COMPARISONS</h1>\"\n","    for step_content in details_dict.values():\n","        html += markdown.markdown(apply_pdf_styling(step_content))\n","        html += \"<hr>\"\n","\n","    html += \"</body></html>\"\n","\n","    with open(output_path, \"w+b\") as f:\n","        pisa_status = pisa.CreatePDF(html, dest=f)\n","\n","    if not pisa_status.err:\n","        print(f\"‚úÖ Delta Report Saved: {output_path}\")\n","    else:\n","        print(\"‚ùå PDF Generation Failed\")\n","\n","# ==========================================\n","# üöÄ MAIN EXECUTION\n","# ==========================================\n","\n","def run_comparator():\n","    setup_environment()\n","\n","    print(\"\\n--- üïµÔ∏è‚Äç‚ôÇÔ∏è Stock Period Comparator ---\")\n","    ticker = input(\"Enter Ticker (e.g., TSLA): \").upper().strip()\n","\n","    # Helper to list available folders\n","    base_path = \"/content/drive/My Drive/Stock_Analysis/Results\"\n","    print(f\"\\nLooking for folders in: {base_path}...\")\n","    try:\n","        available_folders = [f for f in os.listdir(base_path) if ticker in f]\n","        print(\"Found folders:\", available_folders)\n","    except:\n","        pass\n","\n","    old_folder_name = input(f\"Enter OLD folder name (e.g., {ticker}_Q4_2025): \").strip()\n","    new_folder_name = input(f\"Enter NEW folder name (e.g., {ticker}): \").strip()\n","\n","    old_path = os.path.join(base_path, old_folder_name)\n","    new_path = os.path.join(base_path, new_folder_name)\n","\n","    if not os.path.exists(old_path) or not os.path.exists(new_path):\n","        print(\"‚ùå Error: One or both folders do not exist.\")\n","        return\n","\n","    # Run Comparisons\n","    model = genai.GenerativeModel(MODEL_NAME)\n","    comparison_results = {}\n","\n","    print(\"\\n‚ö° Starting Analysis...\")\n","    for step, name in CRITICAL_STEPS.items():\n","        old_txt = get_file_content(old_path, step)\n","        new_txt = get_file_content(new_path, step)\n","\n","        if old_txt and new_txt:\n","            diff = compare_step(model, step, name, old_txt, new_txt)\n","            comparison_results[step] = diff\n","            time.sleep(2) # Rate limit safety\n","        else:\n","            print(f\"   ‚ö†Ô∏è Skipping Step {step} (Missing files in one of the folders)\")\n","\n","    if not comparison_results:\n","        print(\"‚ùå No valid comparisons made.\")\n","        return\n","\n","    # Generate Summary\n","    delta_summary = generate_delta_summary(model, comparison_results, ticker)\n","\n","    # Save PDF to the NEW folder\n","    output_pdf = os.path.join(new_path, f\"{ticker}_Delta_Report_vs_Previous.pdf\")\n","    create_pdf_report(output_pdf, delta_summary, comparison_results)\n","\n","if __name__ == \"__main__\":\n","    run_comparator()"],"metadata":{"id":"plxrscsbfBOK"},"execution_count":null,"outputs":[]}],"metadata":{"colab":{"provenance":[]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}